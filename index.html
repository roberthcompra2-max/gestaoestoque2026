<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o ACA - Dashboard Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; margin: 0; }
        .font-data { font-family: 'Roboto Mono', monospace; }
        thead th { position: sticky; top: 0; background-color: #1e1b4b; color: #fbbf24; z-index: 20; padding: 14px 8px; font-size: 11px; text-transform: uppercase; }
        .row-alert { background-color: #fff1f2 !important; border-left: 6px solid #e11d48; }
        .badge-alert { background-color: #e11d48; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 900; display: inline-block; animation: pulse-soft 3s infinite; }
        @keyframes pulse-soft { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.02); } 100% { opacity: 1; transform: scale(1); } }
        .btn-filter { background-color: #2563eb; color: white; transition: all 0.2s; border-bottom: 3px solid #1e3a8a; }
        .btn-active { background-color: #fbbf24 !important; color: #1e1b4b !important; border-bottom: 3px solid #b45309 !important; font-weight: 900; transform: translateY(1px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
            .no-print { display: none !important; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid black !important; padding: 6px; font-size: 10px; }
        }
    </style>
</head>
<body class="bg-slate-100 pb-10">

    <header class="bg-indigo-950 text-white p-4 sticky top-0 z-50 shadow-xl border-b-4 border-amber-500 no-print">
        <div class="max-w-full mx-auto flex flex-col gap-3">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-black uppercase tracking-tighter text-amber-400 italic leading-none">Gest√£o ACA</h1>
                    <p id="countLabel" class="text-[10px] font-bold text-indigo-300 uppercase mt-1">Sincronizado</p>
                </div>
                <label class="bg-amber-500 text-indigo-950 px-5 py-2 rounded-xl cursor-pointer font-black text-xs uppercase shadow-lg">
                    ATUALIZAR TXT
                    <input type="file" id="fileInput" accept=".txt" class="hidden" />
                </label>
            </div>

            <div id="statsContainer" class="bg-black/20 p-3 rounded-2xl border border-white/10 hidden">
                <div class="flex justify-between text-[10px] font-black uppercase mb-1">
                    <span class="text-amber-400">Distribui√ß√£o</span>
                    <span id="percentLabel" class="text-emerald-400">0% na Loja</span>
                </div>
                <div class="w-full bg-slate-700 h-3 rounded-full overflow-hidden flex mb-3">
                    <div id="barLoja" class="bg-emerald-500 h-full transition-all duration-700"></div>
                    <div id="barDep" class="bg-amber-500 h-full transition-all duration-700"></div>
                </div>
                <div class="flex items-stretch gap-2 text-center">
                    <div class="flex-1 bg-emerald-950/40 rounded-xl p-2 border border-emerald-800/30">
                        <p class="text-[8px] text-emerald-400 font-black">LOJA</p>
                        <p id="txtLojaPe√ßas" class="text-sm font-bold">0</p>
                    </div>
                    <div class="flex-[2] bg-indigo-900/60 rounded-xl p-2 border border-indigo-700/50">
                        <p class="text-[8px] text-indigo-300 font-black">TOTAL / VALOR</p>
                        <p id="txtTotalPe√ßas" class="text-sm font-black">0</p>
                        <p id="txtValorTotal" class="text-xs font-black text-amber-400">R$ 0,00</p>
                    </div>
                    <div class="flex-1 bg-amber-950/40 rounded-xl p-2 border border-amber-800/30">
                        <p class="text-[8px] text-amber-400 font-black">DEP√ìSITO</p>
                        <p id="txtDepPe√ßas" class="text-sm font-bold">0</p>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-2">
                <input type="text" id="searchInput" oninput="aplicarFiltros()" placeholder="Busca inteligente..." class="flex-1 p-3 rounded-xl bg-indigo-900/50 border border-indigo-800 text-white font-bold outline-none" />
                <button onclick="gerarRelatorioImpressao()" class="bg-emerald-600 text-white px-5 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg border-b-4 border-emerald-800 active:translate-y-1">üñ®Ô∏è PDF</button>
            </div>
            
            <div class="flex flex-col gap-1">
                <span class="text-[9px] font-black text-indigo-300 uppercase ml-1">Quantidade de Pe√ßas:</span>
                <div class="flex gap-1 overflow-x-auto pb-1 no-scrollbar">
                    <button onclick="filtrarQtd('exato', 1, this)" class="btn-filter btn-qtd flex-1 min-w-[35px] py-1 rounded text-[10px] font-black">1</button>
                    <button onclick="filtrarQtd('min', 1, this)" class="btn-filter btn-qtd flex-1 min-w-[35px] py-1 rounded text-[10px] font-black">1+</button>
                    <button onclick="filtrarQtd('min', 2, this)" class="btn-filter btn-qtd flex-1 min-w-[35px] py-1 rounded text-[10px] font-black">2+</button>
                    <button onclick="filtrarQtd('min', 4, this)" class="btn-filter btn-qtd flex-1 min-w-[35px] py-1 rounded text-[10px] font-black">4+</button>
                    <button onclick="filtrarQtd('min', 6, this)" class="btn-filter btn-qtd flex-1 min-w-[35px] py-1 rounded text-[10px] font-black">6+</button>
                    <button onclick="filtrarQtd('min', 8, this)" class="btn-filter btn-qtd flex-1 min-w-[35px] py-1 rounded text-[10px] font-black">8+</button>
                    <button onclick="filtrarQtd('min', 10, this)" class="btn-filter btn-qtd flex-1 min-w-[35px] py-1 rounded text-[10px] font-black">10+</button>
                    <button onclick="filtrarQtd('min', 12, this)" class="btn-filter btn-qtd flex-1 min-w-[35px] py-1 rounded text-[10px] font-black">12+</button>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="filtrarAno('24', this)" class="btn-filter btn-ano flex-1 py-2 rounded-lg text-xs font-black">2024</button>
                <button onclick="filtrarAno('25', this)" class="btn-filter btn-ano flex-1 py-2 rounded-lg text-xs font-black">2025</button>
                <button onclick="filtrarAno('26', this)" class="btn-filter btn-ano flex-1 py-2 rounded-lg text-xs font-black">2026</button>
                <button onclick="limparFiltros()" class="bg-slate-600 px-4 py-2 rounded-lg text-[10px] font-black uppercase shadow-md active:translate-y-1">LIMPAR</button>
            </div>
        </div>
    </header>

    <div class="overflow-x-auto bg-white no-print">
        <table class="min-w-full border-collapse">
            <thead>
                <tr>
                    <th class="text-left px-4">NCE</th>
                    <th class="text-left">PRODUTO</th>
                    <th class="text-center">DEP.</th>
                    <th class="text-center">LOJA</th>
                    <th class="text-center">TOTAL</th>
                    <th class="text-right px-4">VALOR (SUB)</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="text-slate-800 text-sm font-data"></tbody>
        </table>
    </div>

    <div id="printArea" class="hidden p-6">
        <h1 class="text-xl font-black border-b-4 border-black pb-1 mb-3 italic uppercase">ACA - Lista de Reposi√ß√£o</h1>
        <p id="printInfo" class="text-[10px] mb-2 font-bold uppercase"></p>
        <table class="w-full">
            <thead>
                <tr class="bg-gray-100 font-bold uppercase text-[9px]">
                    <th>NCE</th><th>Descri√ß√£o</th><th>Dep.</th><th>Loja</th><th>Total</th><th>OK</th>
                </tr>
            </thead>
            <tbody id="printTableBody"></tbody>
        </table>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDcaHwJbY9gT4QUi5S8xBYLAQZhBaqjPhg",
            authDomain: "gestaoestoque-85694.firebaseapp.com",
            databaseURL: "https://gestaoestoque-85694-default-rtdb.firebaseio.com/",
            projectId: "gestaoestoque-85694",
            storageBucket: "gestaoestoque-85694.firebasestorage.app",
            messagingSenderId: "147675200624",
            appId: "1:147675200624:web:9552d9d8abf2914f4448b5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let dadosEstoque = [];
        let anoAtivo = null;
        let qtdMinima = 0;
        let tipoFiltroQtd = 'min'; // 'min' ou 'exato'

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const lines = event.target.result.split('\n');
                let temporario = [];
                lines.forEach(line => {
                    if (line.trim().startsWith('2') && line.includes('.00')) {
                        const matches = line.match(/(-?\d+\.\d{2})/g);
                        const partes = line.trim().split(/\s+/);
                        const nce = partes[2];
                        if (nce && matches && matches.length >= 4) {
                            const d = parseInt(Math.floor(parseFloat(matches[0])));
                            const l = parseInt(Math.floor(parseFloat(matches[1])));
                            const t = parseInt(Math.floor(parseFloat(matches[2])));
                            const u = parseFloat(matches[3]);
                            const desc = line.substring(line.indexOf(nce)+nce.length, line.indexOf(matches[0])).trim();
                            let alerta = (t > 0) && (l < (t * 0.7)) && (d > 0);
                            temporario.push({ nce, desc, dep: d, loja: l, total: t, unitario: u, subtotal: t*u, alerta });
                        }
                    }
                });
                db.ref('estoque_aca').set({ ultimaAtualizacao: new Date().toLocaleString(), itens: temporario });
            };
            reader.readAsText(e.target.files[0]);
        });

        function monitorarNuvem() {
            db.ref('estoque_aca/itens').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) { dadosEstoque = data; aplicarFiltros(); }
            });
        }

        function aplicarFiltros() {
            const valorBusca = document.getElementById('searchInput').value.toLowerCase().trim();
            const termosBusca = valorBusca.split(" ").filter(t => t.length > 0);
            
            let filtrados = dadosEstoque.filter(item => {
                const textoCompleto = (item.desc + " " + item.nce).toLowerCase();
                const matchBusca = termosBusca.every(termo => textoCompleto.includes(termo));
                const matchAno = anoAtivo ? item.desc.includes('/' + anoAtivo) : true;
                
                let matchQtd = true;
                if (tipoFiltroQtd === 'exato') {
                    matchQtd = item.total === qtdMinima;
                } else {
                    matchQtd = item.total >= qtdMinima;
                }
                
                return matchBusca && matchAno && matchQtd;
            });

            filtrados.sort((a, b) => (b.alerta - a.alerta) || (b.total - a.total));
            atualizarDashboard(filtrados);
            renderTable(filtrados);
        }

        function atualizarDashboard(lista) {
            let sL = 0, sD = 0, sT = 0, sF = 0;
            lista.forEach(i => { sL += i.loja; sD += i.dep; sT += i.total; sF += i.subtotal; });
            if (sT > 0) {
                document.getElementById('statsContainer').classList.remove('hidden');
                document.getElementById('barLoja').style.width = ((sL/sT)*100) + "%";
                document.getElementById('barDep').style.width = ((sD/sT)*100) + "%";
                document.getElementById('percentLabel').textContent = ((sL/sT)*100).toFixed(1) + "% NA LOJA";
                document.getElementById('txtTotalPe√ßas').textContent = sT.toLocaleString();
                document.getElementById('txtLojaPe√ßas').textContent = sL.toLocaleString();
                document.getElementById('txtDepPe√ßas').textContent = sD.toLocaleString();
                document.getElementById('txtValorTotal').textContent = sF.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            }
            document.getElementById('countLabel').textContent = `üö® ${lista.filter(x=>x.alerta).length} ALERTAS | üì¶ ${lista.length} ITENS`;
        }

        function renderTable(lista) {
            const body = document.getElementById('tableBody');
            body.innerHTML = '';
            lista.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = item.alerta ? "row-alert border-b" : "border-b";
                tr.innerHTML = `<td class="px-4 py-4 font-bold text-indigo-900">${item.nce}</td><td class="py-4 uppercase text-[11px] font-bold leading-tight">${item.desc} ${item.alerta ? '<br><span class="badge-alert">REPOSI√á√ÉO</span>' : ''}</td><td class="text-center font-bold text-slate-500">${item.dep}</td><td class="text-center font-bold text-slate-900">${item.loja}</td><td class="text-center bg-blue-50 text-xl font-black text-blue-900">${item.total}</td><td class="px-4 text-right"><div class="font-bold">R$ ${item.unitario.toFixed(2)}</div><div class="text-[9px] text-indigo-600 font-black">Sub: R$ ${item.subtotal.toFixed(2)}</div></td>`;
                body.appendChild(tr);
            });
        }

        function filtrarQtd(tipo, valor, btn) {
            document.querySelectorAll('.btn-qtd').forEach(b => b.classList.remove('btn-active'));
            btn.classList.add('btn-active');
            tipoFiltroQtd = tipo;
            qtdMinima = valor; 
            aplicarFiltros();
        }

        function filtrarAno(ano, btn) {
            document.querySelectorAll('.btn-ano').forEach(b => b.classList.remove('btn-active'));
            btn.classList.add('btn-active');
            anoAtivo = ano; aplicarFiltros();
        }

        function gerarRelatorioImpressao() {
            const valorBusca = document.getElementById('searchInput').value.toLowerCase().trim();
            const termosBusca = valorBusca.split(" ").filter(t => t.length > 0);
            
            const listaRepor = dadosEstoque.filter(item => {
                const textoCompleto = (item.desc + " " + item.nce).toLowerCase();
                const matchBusca = termosBusca.every(termo => textoCompleto.includes(termo));
                const matchAno = anoAtivo ? item.desc.includes('/' + anoAtivo) : true;
                let matchQtd = tipoFiltroQtd === 'exato' ? item.total === qtdMinima : item.total >= qtdMinima;
                return item.alerta && matchBusca && matchAno && matchQtd;
            }).sort((a, b) => a.desc.localeCompare(b.desc));

            if(listaRepor.length === 0) return alert("Nada para imprimir!");
            document.getElementById('printTableBody').innerHTML = '';
            document.getElementById('printInfo').textContent = `Filtro: ${tipoFiltroQtd === 'exato' ? 'Exatamente ' : ''}${qtdMinima}${tipoFiltroQtd === 'min' ? '+' : ''} pe√ßas | Total: ${listaRepor.length} itens`;
            listaRepor.forEach(i => {
                document.getElementById('printTableBody').innerHTML += `<tr><td class="font-bold border border-black p-1">${i.nce}</td><td class="uppercase text-[9px] border border-black p-1">${i.desc}</td><td class="text-center font-bold border border-black p-1">${i.dep}</td><td class="text-center border border-black p-1">${i.loja}</td><td class="text-center font-black border border-black p-1">${i.total}</td><td class="border border-black"></td></tr>`;
            });
            window.print();
        }

        function limparFiltros() {
            document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('btn-active'));
            anoAtivo = null; qtdMinima = 0; tipoFiltroQtd = 'min'; document.getElementById('searchInput').value = ''; aplicarFiltros();
        }
        window.onload = monitorarNuvem;
    </script>
</body>
</html>
