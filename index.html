<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o ACA - Dashboard Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500;700&family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; margin: 0; }
        .font-data { font-family: 'Roboto Mono', monospace; font-weight: 700; }
        thead th { position: sticky; top: 0; background-color: #1e1b4b; color: #fbbf24; z-index: 20; padding: 14px 8px; font-size: 11px; text-transform: uppercase; }
        .desc-cell { max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 600; }
        .row-alert { background-color: #fff1f2 !important; border-left: 6px solid #e11d48; }
        .badge-alert { background-color: #e11d48; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 900; display: inline-block; animation: pulse-soft 3s infinite; }
        @keyframes pulse-soft { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.02); } 100% { opacity: 1; transform: scale(1); } }
        .btn-ano { background-color: #2563eb; transition: all 0.2s; color: white; }
        .btn-active { background-color: #fbbf24 !important; color: #1e1b4b !important; font-weight: 900; transform: scale(1.05); }
    </style>
</head>
<body class="bg-slate-100 pb-10">

    <header class="bg-indigo-950 text-white p-4 sticky top-0 z-50 shadow-xl border-b-4 border-amber-500">
        <div class="max-w-full mx-auto flex flex-col gap-3">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-black uppercase tracking-tighter text-amber-400 italic">Gest√£o ACA</h1>
                    <p id="countLabel" class="text-[10px] font-bold text-indigo-300 uppercase italic tracking-widest text-emerald-400">Sincronizando...</p>
                </div>
                <label class="bg-amber-500 text-indigo-950 px-5 py-2 rounded-xl cursor-pointer font-black text-xs uppercase active:scale-95 shadow-lg">
                    ATUALIZAR TXT
                    <input type="file" id="fileInput" accept=".txt" class="hidden" />
                </label>
            </div>

            <div id="statsContainer" class="bg-indigo-900/40 p-3 rounded-xl border border-indigo-800 my-1 hidden">
                <div class="flex justify-between text-[10px] font-black uppercase mb-1">
                    <span class="text-amber-400 italic">Distribui√ß√£o de Estoque</span>
                    <span id="percentLabel" class="text-emerald-400">0% na Loja</span>
                </div>
                <div class="w-full bg-slate-700 h-3 rounded-full overflow-hidden flex shadow-inner">
                    <div id="barLoja" class="bg-emerald-500 h-full transition-all duration-700 shadow-[0_0_10px_rgba(16,185,129,0.5)]" style="width: 0%"></div>
                    <div id="barDep" class="bg-amber-500 h-full transition-all duration-700" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-[9px] mt-1 font-bold italic tracking-tight">
                    <span id="txtLoja" class="text-emerald-300">LOJA: 0</span>
                    <span id="txtDep" class="text-amber-300 text-right">DEP: 0</span>
                </div>
            </div>
            
            <div class="flex gap-2">
                <input type="text" id="searchInput" placeholder="Ex: camisa uv 25..." class="flex-1 p-3 rounded-xl bg-indigo-900/50 border border-indigo-800 text-white placeholder-indigo-300 outline-none text-base font-bold shadow-inner" />
                <select id="minEstoque" onchange="aplicarFiltros()" class="bg-indigo-800 text-amber-400 text-xs font-black rounded-xl px-2 outline-none border border-indigo-700 w-24 text-center">
                    <option value="0">TODOS</option>
                </select>
            </div>
            
            <div class="flex gap-2">
                <button onclick="filtrarAno('24', this)" class="btn-ano flex-1 py-2 rounded-lg text-xs font-black uppercase shadow-md">2024</button>
                <button onclick="filtrarAno('25', this)" class="btn-ano flex-1 py-2 rounded-lg text-xs font-black uppercase shadow-md">2025</button>
                <button onclick="filtrarAno('26', this)" class="btn-ano flex-1 py-2 rounded-lg text-xs font-black uppercase shadow-md">2026</button>
                <button onclick="limparFiltros()" class="bg-slate-600 px-4 py-2 rounded-lg text-[10px] font-black uppercase text-slate-100">LIMPAR</button>
            </div>
        </div>
    </header>

    <div class="overflow-x-auto shadow-2xl bg-white">
        <table class="min-w-full border-collapse">
            <thead>
                <tr>
                    <th class="text-left px-4">NCE</th>
                    <th class="text-left">PRODUTO</th>
                    <th class="text-center">DEP.</th>
                    <th class="text-center">LOJA</th>
                    <th class="text-center">TOTAL</th>
                    <th class="text-right px-4">VALOR</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="text-slate-800 text-sm font-data"></tbody>
        </table>
    </div>

    <script>
        // CONFIGURA√á√ÉO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDcaHwJbY9gT4QUi5S8xBYLAQZhBaqjPhg",
            authDomain: "gestaoestoque-85694.firebaseapp.com",
            databaseURL: "https://gestaoestoque-85694-default-rtdb.firebaseio.com/",
            projectId: "gestaoestoque-85694",
            storageBucket: "gestaoestoque-85694.firebasestorage.app",
            messagingSenderId: "147675200624",
            appId: "1:147675200624:web:9552d9d8abf2914f4448b5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const fileInput = document.getElementById('fileInput');
        const searchInput = document.getElementById('searchInput');
        const minEstoque = document.getElementById('minEstoque');
        const tableBody = document.getElementById('tableBody');
        const countLabel = document.getElementById('countLabel');
        
        // Elementos do Painel de Stats
        const statsContainer = document.getElementById('statsContainer');
        const barLoja = document.getElementById('barLoja');
        const barDep = document.getElementById('barDep');
        const percentLabel = document.getElementById('percentLabel');
        const txtLoja = document.getElementById('txtLoja');
        const txtDep = document.getElementById('txtDep');

        let dadosEstoque = [];
        let anoAtivo = null;

        for(let i=1; i<=12; i++){
            let opt = document.createElement('option');
            opt.value = i; opt.textContent = i + "+";
            minEstoque.appendChild(opt);
        }

        function monitorarNuvem() {
            db.ref('estoque_aca/itens').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    dadosEstoque = data;
                    aplicarFiltros();
                } else {
                    countLabel.textContent = "‚ö†Ô∏è NUVEM VAZIA";
                }
            });
        }

        function salvarNaNuvem(lista) {
            if(confirm("Deseja atualizar o estoque na nuvem para toda a loja?")) {
                db.ref('estoque_aca').set({
                    ultimaAtualizacao: new Date().toLocaleString(),
                    itens: lista
                }).then(() => alert("‚úÖ Estoque atualizado com sucesso!"));
            }
        }

        fileInput.addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const lines = event.target.result.split('\n');
                let temporario = [];
                lines.forEach(line => {
                    if (line.trim().startsWith('2') && line.includes('.00')) {
                        const matches = line.match(/(-?\d+\.\d{2})/g);
                        const partes = line.trim().split(/\s+/);
                        const nce = partes[2]; 
                        const inicioDesc = line.indexOf(nce) + nce.length;
                        const fimDesc = line.indexOf(matches[0]);
                        const desc = line.substring(inicioDesc, fimDesc).trim();
                        if (nce && desc && matches && matches.length >= 4) {
                            const dep = Math.floor(parseFloat(matches[0]));
                            const loja = Math.floor(parseFloat(matches[1]));
                            const total = Math.floor(parseFloat(matches[2]));
                            const precisaAtencao = (loja < (total * 0.7)) && (dep > 0);
                            temporario.push({ nce, desc, dep, loja, total, valor: matches[3], alerta: precisaAtencao });
                        }
                    }
                });
                salvarNaNuvem(temporario);
            };
            reader.readAsText(e.target.files[0]);
        });

        function filtrarAno(ano, btn) {
            document.querySelectorAll('.btn-ano').forEach(b => b.classList.remove('btn-active'));
            btn.classList.add('btn-active');
            anoAtivo = ano;
            aplicarFiltros();
        }

        function limparFiltros() {
            document.querySelectorAll('.btn-ano').forEach(b => b.classList.remove('btn-active'));
            anoAtivo = null; searchInput.value = ''; minEstoque.value = "0";
            aplicarFiltros();
        }

        function aplicarFiltros() {
            let filtrados = [...dadosEstoque];
            const termoBusca = searchInput.value.toLowerCase().trim();
            const min = parseInt(minEstoque.value);

            if (min > 0) filtrados = filtrados.filter(i => i.total >= min);
            if (termoBusca) {
                const termos = termoBusca.split(" ");
                filtrados = filtrados.filter(item => {
                    const textoItem = (item.desc + " " + item.nce).toLowerCase();
                    return termos.every(t => textoItem.includes(t));
                });
            }
            if (anoAtivo) filtrados = filtrados.filter(i => i.desc.includes('/' + anoAtivo));

            // C√ÅLCULO DE DASHBOARD
            let somatorioLoja = 0;
            let somatorioDep = 0;
            let somatorioTotal = 0;

            filtrados.forEach(item => {
                somatorioLoja += item.loja;
                somatorioDep += item.dep;
                somatorioTotal += item.total;
            });

            if (somatorioTotal > 0) {
                statsContainer.classList.remove('hidden');
                const pLoja = ((somatorioLoja / somatorioTotal) * 100).toFixed(1);
                const pDep = (100 - pLoja).toFixed(1);
                
                barLoja.style.width = pLoja + "%";
                barDep.style.width = pDep + "%";
                percentLabel.textContent = `${pLoja}% NA LOJA`;
                txtLoja.textContent = `LOJA: ${somatorioLoja.toLocaleString()}`;
                txtDep.textContent = `DEP: ${somatorioDep.toLocaleString()}`;
            } else {
                statsContainer.classList.add('hidden');
            }

            filtrados.sort((a, b) => (b.alerta - a.alerta) || (b.total - a.total));
            renderTable(filtrados);
            const alertas = filtrados.filter(x => x.alerta).length;
            countLabel.textContent = `üö® ${alertas} ALERTAS | üì¶ ${filtrados.length} ITENS`;
        }

        function renderTable(lista) {
            tableBody.innerHTML = '';
            lista.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = item.alerta ? "row-alert border-b border-red-100" : "border-b border-slate-200";
                const corTotal = item.total > 0 ? 'bg-blue-50 text-blue-800' : 'bg-red-50 text-red-700';
                tr.innerHTML = `
                    <td class="px-4 py-4 text-indigo-900">
                        ${item.alerta ? '<span class="badge-alert mb-1">Aten√ß√£o!</span>' : ''}
                        <div class="text-[11px] font-black">${item.nce}</div>
                    </td>
                    <td class="py-4 uppercase desc-cell text-[11px] leading-tight text-slate-700">${item.desc}</td>
                    <td class="px-2 py-4 text-center text-slate-500 text-base font-medium">${item.dep}</td>
                    <td class="px-2 py-4 text-center text-slate-950 text-base font-black">${item.loja}</td>
                    <td class="px-2 py-4 text-center ${corTotal} text-xl font-black border-x border-slate-200/60">${item.total}</td>
                    <td class="px-4 py-4 text-right font-bold text-slate-900 text-base">R$ ${item.valor}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        searchInput.addEventListener('input', aplicarFiltros);
        window.onload = monitorarNuvem;
    </script>
</body>
</html>
