<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o ACA - Dashboard Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; margin: 0; }
        .font-data { font-family: 'Roboto Mono', monospace; }
        thead th { position: sticky; top: 0; background-color: #1e1b4b; color: #fbbf24; z-index: 20; padding: 14px 8px; font-size: 11px; text-transform: uppercase; }
        .desc-cell { max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 600; }
        .row-alert { background-color: #fff1f2 !important; border-left: 6px solid #e11d48; }
        .badge-alert { background-color: #e11d48; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 900; display: inline-block; animation: pulse-soft 3s infinite; }
        @keyframes pulse-soft { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.02); } 100% { opacity: 1; transform: scale(1); } }
        .btn-ano { background-color: #2563eb; transition: all 0.2s; color: white; }
        .btn-active { background-color: #fbbf24 !important; color: #1e1b4b !important; font-weight: 900; transform: scale(1.05); }
        
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
            .no-print { display: none !important; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid black !important; padding: 6px; font-size: 10px; }
        }
    </style>
</head>
<body class="bg-slate-100 pb-10">

    <header class="bg-indigo-950 text-white p-4 sticky top-0 z-50 shadow-xl border-b-4 border-amber-500 no-print">
        <div class="max-w-full mx-auto flex flex-col gap-3">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-black uppercase tracking-tighter text-amber-400 italic leading-none">Gest√£o ACA</h1>
                    <p id="countLabel" class="text-[10px] font-bold text-indigo-300 uppercase mt-1">Sincronizado</p>
                </div>
                <label class="bg-amber-500 text-indigo-950 px-5 py-2 rounded-xl cursor-pointer font-black text-xs uppercase active:scale-95 shadow-lg">
                    ATUALIZAR TXT
                    <input type="file" id="fileInput" accept=".txt" class="hidden" />
                </label>
            </div>

            <div id="statsContainer" class="bg-black/20 p-3 rounded-2xl border border-white/10 hidden shadow-inner">
                <div class="flex justify-between text-[10px] font-black uppercase mb-1">
                    <span class="text-amber-400">Distribui√ß√£o</span>
                    <span id="percentLabel" class="text-emerald-400">0% na Loja</span>
                </div>
                <div class="w-full bg-slate-700 h-3 rounded-full overflow-hidden flex mb-3">
                    <div id="barLoja" class="bg-emerald-500 h-full transition-all duration-700" style="width: 0%"></div>
                    <div id="barDep" class="bg-amber-500 h-full transition-all duration-700" style="width: 0%"></div>
                </div>
                <div class="flex items-stretch gap-2">
                    <div class="flex-1 bg-emerald-950/40 rounded-xl p-2 text-center border border-emerald-800/30">
                        <p class="text-[8px] text-emerald-400 font-black uppercase">Loja</p>
                        <p id="txtLojaPe√ßas" class="text-sm font-bold text-white">0</p>
                    </div>
                    <div class="flex-[2] bg-indigo-900/60 rounded-xl p-2 text-center border border-indigo-700/50">
                        <div class="mb-1 border-b border-white/10 pb-1">
                            <p class="text-[8px] text-indigo-300 font-black uppercase">Volume Total</p>
                            <p id="txtTotalPe√ßas" class="text-sm font-black text-white">0</p>
                        </div>
                        <p class="text-[8px] text-indigo-300 font-black uppercase">Valor em Estoque</p>
                        <p id="txtValorTotal" class="text-xs font-black text-amber-400 italic">R$ 0,00</p>
                    </div>
                    <div class="flex-1 bg-amber-950/40 rounded-xl p-2 text-center border border-amber-800/30">
                        <p class="text-[8px] text-amber-400 font-black uppercase">Dep√≥sito</p>
                        <p id="txtDepPe√ßas" class="text-sm font-bold text-white">0</p>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-2">
                <input type="text" id="searchInput" oninput="aplicarFiltros()" placeholder="Busca inteligente (ex: uv azul 25)..." class="flex-1 p-3 rounded-xl bg-indigo-900/50 border border-indigo-800 text-white font-bold outline-none placeholder:text-indigo-400" />
                <button onclick="gerarRelatorioImpressao()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2 rounded-xl font-black text-[10px] uppercase shadow-lg border-b-4 border-emerald-800 active:border-0 transition-all">üñ®Ô∏è PDF ALFAB√âTICO</button>
            </div>
            
            <div class="flex gap-2">
                <button onclick="filtrarAno('24', this)" class="btn-ano flex-1 py-2 rounded-lg text-xs font-black uppercase shadow-md">2024</button>
                <button onclick="filtrarAno('25', this)" class="btn-ano flex-1 py-2 rounded-lg text-xs font-black uppercase shadow-md">2025</button>
                <button onclick="filtrarAno('26', this)" class="btn-ano flex-1 py-2 rounded-lg text-xs font-black uppercase shadow-md">2026</button>
                <button onclick="limparFiltros()" class="bg-slate-600 px-4 py-2 rounded-lg text-[10px] font-black uppercase text-slate-100">LIMPAR</button>
            </div>
        </div>
    </header>

    <div class="overflow-x-auto shadow-2xl bg-white no-print">
        <table class="min-w-full border-collapse">
            <thead>
                <tr>
                    <th class="text-left px-4">NCE</th>
                    <th class="text-left">PRODUTO</th>
                    <th class="text-center">DEP.</th>
                    <th class="text-center">LOJA</th>
                    <th class="text-center">TOTAL</th>
                    <th class="text-right px-4">VALOR (SUB)</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="text-slate-800 text-sm font-data"></tbody>
        </table>
    </div>

    <div id="printArea" class="hidden p-6">
        <div class="flex justify-between items-end border-b-4 border-black pb-2 mb-4">
            <div>
                <h1 class="text-xl font-black uppercase italic">ACA - LISTA DE REPOSI√á√ÉO (A-Z)</h1>
                <p id="printInfo" class="text-[10px] font-bold uppercase"></p>
            </div>
            <div class="text-right text-[9px] font-bold">
                GERADO EM: <span id="printDate"></span>
            </div>
        </div>
        <table class="w-full border-collapse">
            <thead>
                <tr class="bg-gray-100">
                    <th class="text-left p-1">NCE</th>
                    <th class="text-left p-1">DESCRI√á√ÉO</th>
                    <th class="text-center p-1">DEP.</th>
                    <th class="text-center p-1">LOJA</th>
                    <th class="text-center p-1">TOTAL</th>
                    <th class="text-center p-1 w-10">VISTO</th>
                </tr>
            </thead>
            <tbody id="printTableBody"></tbody>
        </table>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDcaHwJbY9gT4QUi5S8xBYLAQZhBaqjPhg",
            authDomain: "gestaoestoque-85694.firebaseapp.com",
            databaseURL: "https://gestaoestoque-85694-default-rtdb.firebaseio.com/",
            projectId: "gestaoestoque-85694",
            storageBucket: "gestaoestoque-85694.firebasestorage.app",
            messagingSenderId: "147675200624",
            appId: "1:147675200624:web:9552d9d8abf2914f4448b5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let dadosEstoque = [];
        let anoAtivo = null;

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const lines = event.target.result.split('\n');
                let temporario = [];
                lines.forEach(line => {
                    if (line.trim().startsWith('2') && line.includes('.00')) {
                        const matches = line.match(/(-?\d+\.\d{2})/g);
                        const partes = line.trim().split(/\s+/);
                        const nce = partes[2];
                        if (nce && matches && matches.length >= 4) {
                            const d = parseInt(Math.floor(parseFloat(matches[0])));
                            const l = parseInt(Math.floor(parseFloat(matches[1])));
                            const t = parseInt(Math.floor(parseFloat(matches[2])));
                            const u = parseFloat(matches[3]);
                            const desc = line.substring(line.indexOf(nce)+nce.length, line.indexOf(matches[0])).trim();
                            let alerta = (t > 1) && (l < (t * 0.7)) && (d > 0);
                            temporario.push({ nce, desc, dep: d, loja: l, total: t, unitario: u, subtotal: t*u, alerta });
                        }
                    }
                });
                if(confirm("Deseja salvar na nuvem?")) {
                    db.ref('estoque_aca').set({ ultimaAtualizacao: new Date().toLocaleString(), itens: temporario });
                }
            };
            reader.readAsText(e.target.files[0]);
        });

        function monitorarNuvem() {
            db.ref('estoque_aca/itens').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) { dadosEstoque = data; aplicarFiltros(); }
            });
        }

        function aplicarFiltros() {
            const valorBusca = document.getElementById('searchInput').value.toLowerCase().trim();
            const termosBusca = valorBusca.split(" ").filter(t => t.length > 0);
            
            let filtrados = dadosEstoque.filter(item => {
                const textoCompleto = (item.desc + " " + item.nce).toLowerCase();
                const matchBusca = termosBusca.every(termo => textoCompleto.includes(termo));
                const matchAno = anoAtivo ? item.desc.includes('/' + anoAtivo) : true;
                return matchBusca && matchAno;
            });

            // Tela principal mant√©m ordem: Alerta -> Maior Volume
            filtrados.sort((a, b) => {
                if (a.alerta !== b.alerta) return b.alerta - a.alerta;
                return b.total - a.total;
            });

            atualizarDashboard(filtrados);
            renderTable(filtrados);
        }

        function atualizarDashboard(lista) {
            let sL = 0, sD = 0, sT = 0, sF = 0;
            lista.forEach(i => { sL += i.loja; sD += i.dep; sT += i.total; sF += i.subtotal; });
            if (sT > 0) {
                document.getElementById('statsContainer').classList.remove('hidden');
                document.getElementById('barLoja').style.width = ((sL/sT)*100) + "%";
                document.getElementById('barDep').style.width = ((sD/sT)*100) + "%";
                document.getElementById('percentLabel').textContent = ((sL/sT)*100).toFixed(1) + "% NA LOJA";
                document.getElementById('txtTotalPe√ßas').textContent = sT.toLocaleString();
                document.getElementById('txtLojaPe√ßas').textContent = sL.toLocaleString();
                document.getElementById('txtDepPe√ßas').textContent = sD.toLocaleString();
                document.getElementById('txtValorTotal').textContent = sF.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
            }
            document.getElementById('countLabel').textContent = `üö® ${lista.filter(x=>x.alerta).length} ALERTAS | üì¶ ${lista.length} ITENS`;
        }

        function renderTable(lista) {
            const body = document.getElementById('tableBody');
            body.innerHTML = '';
            lista.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = item.alerta ? "row-alert border-b" : "border-b";
                tr.innerHTML = `
                    <td class="px-4 py-4 font-bold text-indigo-900">${item.nce}</td>
                    <td class="py-4 uppercase text-[11px] font-bold leading-tight">${item.desc} ${item.alerta ? '<br><span class="badge-alert">REPOSI√á√ÉO</span>' : ''}</td>
                    <td class="text-center font-bold text-slate-500">${item.dep}</td>
                    <td class="text-center font-bold text-slate-900">${item.loja}</td>
                    <td class="text-center bg-blue-50 text-xl font-black text-blue-900 border-x border-slate-100">${item.total}</td>
                    <td class="px-4 text-right">
                        <div class="font-bold text-slate-900">R$ ${item.unitario.toFixed(2)}</div>
                        <div class="text-[9px] text-indigo-600 font-black">Sub: R$ ${item.subtotal.toFixed(2)}</div>
                    </td>
                `;
                body.appendChild(tr);
            });
        }

        function gerarRelatorioImpressao() {
            const valorBusca = document.getElementById('searchInput').value.toLowerCase().trim();
            const termosBusca = valorBusca.split(" ").filter(t => t.length > 0);
            
            const listaRepor = dadosEstoque.filter(item => {
                const textoCompleto = (item.desc + " " + item.nce).toLowerCase();
                const matchBusca = termosBusca.every(termo => textoCompleto.includes(termo));
                const matchAno = anoAtivo ? item.desc.includes('/' + anoAtivo) : true;
                return item.alerta && matchBusca && matchAno;
            });

            // NOVIDADE: ORDEM ALFAB√âTICA (A-Z) NO PDF
            listaRepor.sort((a, b) => a.desc.localeCompare(b.desc));

            if(listaRepor.length === 0) return alert("N√£o h√° itens de reposi√ß√£o!");
            
            const pBody = document.getElementById('printTableBody');
            pBody.innerHTML = '';
            document.getElementById('printDate').textContent = new Date().toLocaleString();
            document.getElementById('printInfo').textContent = `ORDEM ALFAB√âTICA | TOTAL: ${listaRepor.length} ITENS`;
            
            listaRepor.forEach(i => {
                pBody.innerHTML += `
                    <tr>
                        <td class="font-bold p-1 border border-black">${i.nce}</td>
                        <td class="uppercase text-[9px] p-1 border border-black">${i.desc}</td>
                        <td class="text-center font-bold p-1 border border-black">${i.dep}</td>
                        <td class="text-center p-1 border border-black">${i.loja}</td>
                        <td class="text-center font-black p-1 border border-black">${i.total}</td>
                        <td class="border border-black"></td>
                    </tr>`;
            });
            window.print();
        }

        function filtrarAno(ano, btn) {
            document.querySelectorAll('.btn-ano').forEach(b => b.classList.remove('btn-active'));
            btn.classList.add('btn-active');
            anoAtivo = ano; aplicarFiltros();
        }

        function limparFiltros() {
            document.querySelectorAll('.btn-ano').forEach(b => b.classList.remove('btn-active'));
            anoAtivo = null; document.getElementById('searchInput').value = ''; aplicarFiltros();
        }

        window.onload = monitorarNuvem;
    </script>
</body>
</html>
